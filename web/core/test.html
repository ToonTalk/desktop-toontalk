<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>ToonTalk Platform Layer Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #222;
            color: #fff;
        }
        #canvas-container {
            background: #000;
            border: 2px solid #0f0;
            width: 800px;
            height: 600px;
            position: relative;
        }
        button {
            margin: 10px;
            padding: 10px 20px;
            font-size: 16px;
        }
        #log {
            background: #111;
            border: 1px solid #333;
            padding: 10px;
            margin-top: 20px;
            height: 200px;
            overflow-y: auto;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <h1>üöÄ ToonTalk Platform Layer Test</h1>
    <p>Testing C++ ‚Üí JavaScript rendering bridge</p>

    <div id="canvas-container">
        <canvas id="canvas" width="800" height="600"></canvas>
    </div>

    <div>
        <button onclick="testPlatform()">Test Platform Layer</button>
        <button onclick="testNumber()">Test Number Display</button>
        <button onclick="testArithmetic()">Test Arithmetic</button>
        <button onclick="clearCanvas()">Clear Canvas</button>
    </div>

    <div id="log"></div>

    <script>
        // Set up the rendering bridge that C++ will call
        window.ToonTalkRenderer = {
            context: null,

            init: function() {
                const canvas = document.getElementById('canvas');
                this.context = canvas.getContext('2d');
                this.log('ToonTalkRenderer initialized');
            },

            drawRect: function(x, y, width, height, color) {
                const ctx = this.context;
                const colorStr = '#' + color.toString(16).padStart(6, '0');
                ctx.fillStyle = colorStr;
                ctx.fillRect(x, y, width, height);
                this.log(`drawRect(${x}, ${y}, ${width}, ${height}, ${colorStr})`);
            },

            drawCircle: function(x, y, radius, color) {
                const ctx = this.context;
                const colorStr = '#' + color.toString(16).padStart(6, '0');
                ctx.fillStyle = colorStr;
                ctx.beginPath();
                ctx.arc(x, y, radius, 0, 2 * Math.PI);
                ctx.fill();
                this.log(`drawCircle(${x}, ${y}, ${radius}, ${colorStr})`);
            },

            drawLine: function(x1, y1, x2, y2, color) {
                const ctx = this.context;
                const colorStr = '#' + color.toString(16).padStart(6, '0');
                ctx.strokeStyle = colorStr;
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(x1, y1);
                ctx.lineTo(x2, y2);
                ctx.stroke();
                this.log(`drawLine(${x1}, ${y1}, ${x2}, ${y2}, ${colorStr})`);
            },

            drawText: function(text, x, y, fontSize, color, fontFamily = 'Arial') {
                const ctx = this.context;
                const colorStr = '#' + color.toString(16).padStart(6, '0');
                ctx.fillStyle = colorStr;
                ctx.font = `${fontSize}px ${fontFamily}`;
                ctx.fillText(text, x, y);
                this.log(`drawText("${text}", ${x}, ${y}, ${fontSize}, ${colorStr})`);
            },

            clear: function() {
                const ctx = this.context;
                ctx.fillStyle = '#000';
                ctx.fillRect(0, 0, 800, 600);
                this.log('clear()');
            },

            present: function() {
                // No-op for canvas 2D (auto-presents)
            },

            setClipRect: function(x, y, width, height) {
                const ctx = this.context;
                ctx.save();
                ctx.beginPath();
                ctx.rect(x, y, width, height);
                ctx.clip();
                this.log(`setClipRect(${x}, ${y}, ${width}, ${height})`);
            },

            clearClip: function() {
                const ctx = this.context;
                ctx.restore();
                this.log('clearClip()');
            },

            log: function(message) {
                console.log('[ToonTalkRenderer]', message);
                const logDiv = document.getElementById('log');
                const entry = document.createElement('div');
                entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
                logDiv.appendChild(entry);
                logDiv.scrollTop = logDiv.scrollHeight;
            }
        };

        // Initialize renderer
        window.ToonTalkRenderer.init();

        // Load WASM module
        let Module;

        // Wait for the external script to load, then initialize WASM
        function initWasm() {
            if (typeof createToonTalkCore === 'undefined') {
                window.ToonTalkRenderer.log('‚è≥ Waiting for WASM module to load...');
                setTimeout(initWasm, 100);
                return;
            }

            createToonTalkCore().then(mod => {
                Module = mod;
                window.ToonTalkRenderer.log('‚úÖ WASM module loaded successfully!');

                // Debug: log what's in the Module
                const moduleKeys = Object.keys(Module).filter(k => !k.startsWith('_') && typeof Module[k] === 'function');
                window.ToonTalkRenderer.log(`Module exports: ${moduleKeys.join(', ')}`);

                window.ToonTalkRenderer.log('Ready to test platform layer');
            }).catch(err => {
                window.ToonTalkRenderer.log('‚ùå Error loading WASM: ' + err);
                console.error(err);
            });
        }

        // Start initialization after page loads
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initWasm);
        } else {
            initWasm();
        }

        function testPlatform() {
            if (!Module) {
                alert('WASM not loaded yet!');
                return;
            }

            window.ToonTalkRenderer.log('--- Testing platform layer ---');

            try {
                // Call the C++ test function
                Module.testPlatformLayer();
                window.ToonTalkRenderer.log('‚úÖ Platform layer test completed!');
            } catch (err) {
                window.ToonTalkRenderer.log('‚ùå Error: ' + err);
                console.error(err);
            }
        }

        function testNumber() {
            if (!Module) {
                alert('WASM not loaded yet!');
                return;
            }

            window.ToonTalkRenderer.log('--- Testing Number class ---');

            try {
                // Clear canvas first
                window.ToonTalkRenderer.clear();

                // Row 1: Regular numbers (light green background)
                // Create a number with value 42
                const number1 = new Module.Number(42, 50, 50, 150, 80, Module.NumberOperation.NO_NUMBER_OPERATION);
                window.ToonTalkRenderer.log('Created number: 42');
                number1.display();

                // Create a decimal number
                const number2 = new Module.Number(3.14159, 220, 50, 180, 80, Module.NumberOperation.NO_NUMBER_OPERATION);
                window.ToonTalkRenderer.log('Created number: 3.14159');
                number2.display();

                // Create a negative number
                const number3 = new Module.Number(-123.456, 420, 50, 180, 80, Module.NumberOperation.NO_NUMBER_OPERATION);
                window.ToonTalkRenderer.log('Created number: -123.456');
                number3.display();

                // Row 2: Operations (yellowish green background)
                // Addition operation
                const addOp = new Module.Number(5, 50, 160, 120, 80, Module.NumberOperation.INCREASE_BY);
                window.ToonTalkRenderer.log('Created operation: + 5');
                addOp.display();

                // Subtraction operation
                const subOp = new Module.Number(10, 190, 160, 120, 80, Module.NumberOperation.SUBTRACT_FROM);
                window.ToonTalkRenderer.log('Created operation: - 10');
                subOp.display();

                // Multiplication operation
                const mulOp = new Module.Number(2, 330, 160, 120, 80, Module.NumberOperation.MULTIPLY_BY);
                window.ToonTalkRenderer.log('Created operation: * 2');
                mulOp.display();

                // Division operation
                const divOp = new Module.Number(3, 470, 160, 120, 80, Module.NumberOperation.DIVIDE_BY);
                window.ToonTalkRenderer.log('Created operation: / 3');
                divOp.display();

                // Row 3: Operations without values (just symbols)
                const justAdd = new Module.Number(0, 50, 270, 100, 80, Module.NumberOperation.INCREASE_BY);
                window.ToonTalkRenderer.log('Created operation: +');
                justAdd.display();

                const justMul = new Module.Number(0, 170, 270, 100, 80, Module.NumberOperation.MULTIPLY_BY);
                window.ToonTalkRenderer.log('Created operation: *');
                justMul.display();

                const justEqual = new Module.Number(0, 290, 270, 100, 80, Module.NumberOperation.MAKE_EQUAL);
                window.ToonTalkRenderer.log('Created operation: =');
                justEqual.display();

                window.ToonTalkRenderer.log('‚úÖ Number test completed!');
                window.ToonTalkRenderer.log('');
                window.ToonTalkRenderer.log('Notice:');
                window.ToonTalkRenderer.log('  - Top row: Regular numbers (light green)');
                window.ToonTalkRenderer.log('  - Middle row: Operations with values (yellowish green)');
                window.ToonTalkRenderer.log('  - Bottom row: Operations without values (just symbols)');

                // Clean up
                number1.delete();
                number2.delete();
                number3.delete();
                addOp.delete();
                subOp.delete();
                mulOp.delete();
                divOp.delete();
                justAdd.delete();
                justMul.delete();
                justEqual.delete();
            } catch (err) {
                window.ToonTalkRenderer.log('‚ùå Error: ' + err);
                console.error(err);
            }
        }

        function testArithmetic() {
            if (!Module) {
                alert('WASM not loaded yet!');
                return;
            }

            window.ToonTalkRenderer.log('--- Testing Arithmetic Operations ---');

            try {
                // Clear canvas first
                window.ToonTalkRenderer.clear();

                // Create a starting number
                const num = new Module.Number(10, 50, 50, 150, 80, Module.NumberOperation.NO_NUMBER_OPERATION);
                window.ToonTalkRenderer.log('Starting with: 10');
                num.display();

                // Create operations
                const addOp = new Module.Number(5, 220, 50, 120, 80, Module.NumberOperation.INCREASE_BY);
                window.ToonTalkRenderer.log('Operation: + 5');
                addOp.display();

                const mulOp = new Module.Number(2, 360, 50, 120, 80, Module.NumberOperation.MULTIPLY_BY);
                window.ToonTalkRenderer.log('Operation: * 2');
                mulOp.display();

                // Apply operations step by step
                window.ToonTalkRenderer.log('');
                window.ToonTalkRenderer.log('Step 1: Apply "+ 5" to 10');

                // Get the result
                let result1 = addOp.applyTo(num.getValue());
                window.ToonTalkRenderer.log('  Result: ' + result1);

                // Update the number
                num.setValue(result1);
                num.setPosition(50, 170);
                num.display();

                window.ToonTalkRenderer.log('');
                window.ToonTalkRenderer.log('Step 2: Apply "* 2" to ' + result1);

                let result2 = mulOp.applyTo(num.getValue());
                window.ToonTalkRenderer.log('  Result: ' + result2);

                // Update the number again
                num.setValue(result2);
                num.setPosition(50, 290);
                num.display();

                // Show the computation chain
                window.ToonTalkRenderer.log('');
                window.ToonTalkRenderer.log('Computation: 10 + 5 = 15, then 15 * 2 = 30');
                window.ToonTalkRenderer.log('Final result: ' + num.getValue());

                // Test more operations
                window.ToonTalkRenderer.log('');
                window.ToonTalkRenderer.log('--- Additional Operations ---');

                const num2 = new Module.Number(100, 300, 170, 150, 80, Module.NumberOperation.NO_NUMBER_OPERATION);
                window.ToonTalkRenderer.log('Number: 100');
                num2.display();

                const subOp = new Module.Number(25, 470, 170, 120, 80, Module.NumberOperation.SUBTRACT_FROM);
                window.ToonTalkRenderer.log('Operation: - 25');
                subOp.display();

                let result3 = subOp.applyTo(num2.getValue());
                window.ToonTalkRenderer.log('100 - 25 = ' + result3);

                num2.setValue(result3);
                num2.setPosition(300, 290);
                num2.display();

                window.ToonTalkRenderer.log('');
                window.ToonTalkRenderer.log('‚úÖ Arithmetic test completed!');

                // Clean up
                num.delete();
                addOp.delete();
                mulOp.delete();
                num2.delete();
                subOp.delete();
            } catch (err) {
                window.ToonTalkRenderer.log('‚ùå Error: ' + err);
                console.error(err);
            }
        }

        function clearCanvas() {
            window.ToonTalkRenderer.clear();
        }
    </script>
    <script src="build/toontalk-core.js"></script>
</body>
</html>
